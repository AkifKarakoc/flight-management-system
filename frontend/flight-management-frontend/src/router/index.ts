import { createRouter, createWebHistory, type Router } from 'vue-router'
import { useAuthStore } from '@/stores/auth.js'
import authService from '@/services/authService'
import { ElMessage } from 'element-plus'

// Lazy import components
const AuthLayout = () => import('@/layouts/AuthLayout.vue')
const MainLayout = () => import('@/layouts/MainLayout.vue')
const LoginPage = () => import('@/pages/auth/LoginPage.vue')
const DashboardPage = () => import('@/pages/dashboard/DashboardPage.vue')
const NotFoundPage = () => import('@/pages/NotFoundPage.vue')

// Reference Management Pages
const AirlineManagement = () => import('@/pages/reference/AirlineManagement.vue')
const AirportManagement = () => import('@/pages/reference/AirportManagement.vue')
const AircraftManagement = () => import('@/pages/reference/AircraftManagement.vue')
const RouteManagement = () => import('@/pages/reference/RouteManagement.vue')
const CrewManagement = () => import('@/pages/reference/CrewManagement.vue')

// Flight Management Pages
const FlightManagement = () => import('@/pages/flights/FlightManagement.vue')
const FlightCreate = () => import('@/pages/flights/FlightCreate.vue')
const FlightEdit = () => import('@/pages/flights/FlightEdit.vue')
const FlightUpload = () => import('@/pages/flights/FlightUpload.vue')

const routes = [
  // Auth Routes
  {
    path: '/auth',
    component: AuthLayout,
    meta: { requiresAuth: false },
    children: [
      {
        path: '',
        redirect: '/auth/login'
      },
      {
        path: 'login',
        name: 'Login',
        component: LoginPage,
        meta: {
          title: 'Giri≈ü Yap',
          requiresAuth: false
        }
      }
    ]
  },

  // Main App Routes
  {
    path: '/',
    component: MainLayout,
    redirect: '/dashboard',
    meta: { requiresAuth: true },
    children: [
      {
        path: 'dashboard',
        name: 'Dashboard',
        component: DashboardPage,
        meta: {
          title: 'Dashboard',
          requiresAuth: true
        }
      },

      // Reference Management Routes
      {
        path: 'airlines',
        name: 'Airlines',
        component: AirlineManagement,
        meta: {
          title: 'Havayollarƒ±',
          requiresAuth: true,
          roles: ['ADMIN', 'USER'] // Bu sayfaya hangi roller eri≈üebilir
        }
      },
      {
        path: 'airports',
        name: 'Airports',
        component: AirportManagement,
        meta: {
          title: 'Havaalanlarƒ±',
          requiresAuth: true,
          roles: ['ADMIN', 'USER']
        }
      },
      {
        path: 'aircrafts',
        name: 'Aircrafts',
        component: AircraftManagement,
        meta: {
          title: 'U√ßaklar',
          requiresAuth: true,
          roles: ['ADMIN', 'USER']
        }
      },
      {
        path: 'routes',
        name: 'Routes',
        component: RouteManagement,
        meta: {
          title: 'Rotalar',
          requiresAuth: true,
          roles: ['ADMIN', 'USER']
        }
      },
      {
        path: 'crew',
        name: 'CrewMembers',
        component: CrewManagement,
        meta: {
          title: 'Ekip √úyeleri',
          requiresAuth: true,
          roles: ['ADMIN']
        }
      },

      // Flight Management Routes
      {
        path: 'flights',
        name: 'Flights',
        component: FlightManagement,
        meta: {
          title: 'U√ßu≈ülar',
          requiresAuth: true,
          roles: ['ADMIN', 'USER']
        }
      },
      {
        path: 'flights/create',
        name: 'FlightCreate',
        component: FlightCreate,
        meta: {
          title: 'Yeni U√ßu≈ü',
          requiresAuth: true,
          roles: ['ADMIN']
        }
      },
      {
        path: 'flights/edit/:id',
        name: 'FlightEdit',
        component: FlightEdit,
        meta: {
          title: 'U√ßu≈ü D√ºzenle',
          requiresAuth: true,
          roles: ['ADMIN']
        }
      },
      {
        path: 'flights/upload',
        name: 'FlightUpload',
        component: FlightUpload,
        meta: {
          title: 'U√ßu≈ü Y√ºkle',
          requiresAuth: true,
          roles: ['ADMIN']
        }
      },
      {
        path: 'flights/active',
        name: 'FlightActive',
        component: () => import('@/pages/flights/FlightActive.vue'),
        meta: {
          title: 'Aktif U√ßu≈ülar',
          requiresAuth: true,
          roles: ['ADMIN', 'USER']
        }
      },

      // Reports Routes
      {
        path: 'reports',
        name: 'Reports',
        redirect: '/reports/flights'
      },
      {
        path: 'reports/flights',
        name: 'ReportsFlights',
        component: () => import('@/pages/reports/FlightReports.vue'),
        meta: {
          title: 'U√ßu≈ü Raporlarƒ±',
          requiresAuth: true,
          roles: ['ADMIN', 'USER']
        }
      },
      {
        path: 'reports/kpi',
        name: 'ReportsKPI',
        component: () => import('@/pages/reports/KPIReports.vue'),
        meta: {
          title: 'KPI Raporlarƒ±',
          requiresAuth: true,
          roles: ['ADMIN', 'USER']
        }
      },
      {
        path: 'reports/analytics',
        name: 'ReportsAnalytics',
        component: () => import('@/pages/reports/Analytics.vue'),
        meta: {
          title: 'Veri Analizi',
          requiresAuth: true,
          roles: ['ADMIN', 'USER']
        }
      },

      // System Management Routes (Admin Only)
      {
        path: 'system',
        name: 'System',
        redirect: '/system/health'
      },
      {
        path: 'system/health',
        name: 'SystemHealth',
        component: () => import('@/pages/system/SystemHealth.vue'),
        meta: {
          title: 'Sistem Durumu',
          requiresAuth: true,
          roles: ['ADMIN']
        }
      },
      {
        path: 'system/logs',
        name: 'SystemLogs',
        component: () => import('@/pages/system/SystemLogs.vue'),
        meta: {
          title: 'Sistem Loglarƒ±',
          requiresAuth: true,
          roles: ['ADMIN']
        }
      },
      {
        path: 'system/settings',
        name: 'SystemSettings',
        component: () => import('@/pages/system/SystemSettings.vue'),
        meta: {
          title: 'Sistem Ayarlarƒ±',
          requiresAuth: true,
          roles: ['ADMIN']
        }
      }
    ]
  },

  // 404 Route
  {
    path: '/:pathMatch(.*)*',
    name: 'NotFound',
    component: NotFoundPage,
    meta: {
      title: 'Sayfa Bulunamadƒ±',
      requiresAuth: false
    }
  }
]

const router: Router = createRouter({
  history: createWebHistory(),
  routes,
  scrollBehavior(to, from, savedPosition) {
    if (savedPosition) {
      return savedPosition
    } else {
      return { top: 0 }
    }
  }
})

// Enhanced Navigation Guards with Security
router.beforeEach(async (to, from, next) => {
  console.log(`üîç Navigation: ${from.path} ‚Üí ${to.path}`)

  const authStore = useAuthStore()

  // Set page title
  if (to.meta?.title) {
    document.title = `${to.meta.title} - Flight Management System`
  } else {
    document.title = 'Flight Management System'
  }

  // 1. Auth pages kontrol√º - authenticated user auth'a gitmeye √ßalƒ±≈üƒ±yorsa
  if (to.path.startsWith('/auth')) {
    if (authStore.isAuthenticated) {
      console.log('‚úÖ Already authenticated, redirecting to dashboard')
      next('/dashboard')
      return
    }
    // Auth sayfalarƒ±na devam et
    next()
    return
  }

  // 2. Protected route kontrol√º
  if (to.meta?.requiresAuth !== false) {
    // Session validation yap
    if (!authService.validateSession()) {
      console.log('‚ùå Session invalid, redirecting to login')
      ElMessage.warning('Oturumunuz ge√ßersiz. L√ºtfen tekrar giri≈ü yapƒ±n.')
      authStore.clearSessionTimeout()

      next({
        path: '/auth/login',
        query: { redirect: to.fullPath }
      })
      return
    }

    // Store'dan auth durumunu kontrol et
    if (!authStore.isAuthenticated) {
      console.log('‚ùå Not authenticated, redirecting to login')
      ElMessage.warning('Bu sayfaya eri≈ümek i√ßin giri≈ü yapmalƒ±sƒ±nƒ±z')

      next({
        path: '/auth/login',
        query: { redirect: to.fullPath }
      })
      return
    }

    // 3. Role-based access control
    if (to.meta?.roles && Array.isArray(to.meta.roles)) {
      const userRoles = authStore.userRoles
      const hasRequiredRole = to.meta.roles.some(role =>
        userRoles.includes(role) ||
        userRoles.includes(`ROLE_${role}`) ||
        authService.hasRole(role)
      )

      if (!hasRequiredRole) {
        console.log('‚ùå Insufficient permissions for route:', to.path)
        ElMessage.error('Bu sayfaya eri≈üim yetkiniz bulunmuyor')

        // Dashboard'a y√∂nlendir veya √∂nceki sayfaya geri d√∂n
        next(from.path === '/auth/login' ? '/dashboard' : from.path || '/dashboard')
        return
      }
    }

    // 4. Permission-based access control (opsiyonel)
    if (to.meta?.permissions && Array.isArray(to.meta.permissions)) {
      const hasRequiredPermission = to.meta.permissions.some(permission =>
        authService.hasPermission(permission)
      )

      if (!hasRequiredPermission) {
        console.log('‚ùå Insufficient permissions for route:', to.path)
        ElMessage.error('Bu i≈ülem i√ßin yetkiniz bulunmuyor')
        next(from.path || '/dashboard')
        return
      }
    }

    // 5. Token expiry check ve refresh
    if (authService.isTokenExpiringSoon()) {
      console.log('‚ö†Ô∏è Token expiring soon, attempting refresh...')
      try {
        await authStore.refreshAuthToken()
        console.log('‚úÖ Token refreshed successfully')
      } catch (error) {
        console.error('‚ùå Token refresh failed:', error)
        ElMessage.error('Oturumunuz sona erdi. L√ºtfen tekrar giri≈ü yapƒ±n.')
        await authStore.logout()
        next('/auth/login')
        return
      }
    }

    console.log('‚úÖ Auth check passed, proceeding to route')
  }

  // T√ºm kontroller ge√ßti
  next()
})

// After each navigation
router.afterEach((to, from, failure) => {
  if (failure) {
    console.error('‚ùå Navigation failed:', failure)
    return
  }

  console.log(`‚úÖ Navigation completed: ${from.path} ‚Üí ${to.path}`)

  // Update last activity
  if (to.meta?.requiresAuth !== false) {
    authService.updateLastActivity()
  }
})

// Error handling
router.onError((error: Error) => {
  console.error('‚ùå Router error:', error)
  ElMessage.error('Sayfa y√ºklenirken hata olu≈ütu')
})

export default router
