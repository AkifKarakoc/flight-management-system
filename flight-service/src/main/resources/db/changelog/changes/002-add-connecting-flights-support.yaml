databaseChangeLog:
  - changeSet:
      id: add-connecting-flights-columns
      author: flight-management-team
      changes:
        - addColumn:
            tableName: flights
            columns:
              - column:
                  name: parent_flight_id
                  type: BIGINT
                  constraints:
                    nullable: true
              - column:
                  name: segment_number
                  type: INTEGER
                  defaultValueNumeric: 1
                  constraints:
                    nullable: false
              - column:
                  name: is_connecting_flight
                  type: BOOLEAN
                  defaultValueBoolean: false
                  constraints:
                    nullable: false
              - column:
                  name: connection_time_minutes
                  type: INTEGER
                  constraints:
                    nullable: true

  - changeSet:
      id: add-parent-flight-foreign-key
      author: flight-management-team
      changes:
        - addForeignKeyConstraint:
            baseTableName: flights
            baseColumnNames: parent_flight_id
            referencedTableName: flights
            referencedColumnNames: id
            constraintName: fk_flights_parent_flight

  - changeSet:
      id: create-flight-connections-table
      author: flight-management-team
      changes:
        - createTable:
            tableName: flight_connections
            columns:
              - column:
                  name: id
                  type: BIGINT
                  autoIncrement: true
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: main_flight_id
                  type: BIGINT
                  constraints:
                    nullable: false
              - column:
                  name: segment_flight_id
                  type: BIGINT
                  constraints:
                    nullable: false
              - column:
                  name: segment_order
                  type: INTEGER
                  constraints:
                    nullable: false
              - column:
                  name: connection_time_minutes
                  type: INTEGER
                  constraints:
                    nullable: true
              - column:
                  name: created_at
                  type: TIMESTAMP
                  defaultValueComputed: CURRENT_TIMESTAMP

  - changeSet:
      id: add-flight-connections-foreign-keys
      author: flight-management-team
      changes:
        - addForeignKeyConstraint:
            baseTableName: flight_connections
            baseColumnNames: main_flight_id
            referencedTableName: flights
            referencedColumnNames: id
            constraintName: fk_flight_connections_main_flight
        - addForeignKeyConstraint:
            baseTableName: flight_connections
            baseColumnNames: segment_flight_id
            referencedTableName: flights
            referencedColumnNames: id
            constraintName: fk_flight_connections_segment_flight

  - changeSet:
      id: add-flight-connections-indexes
      author: flight-management-team
      changes:
        - createIndex:
            indexName: idx_flight_connections_main_flight
            tableName: flight_connections
            columns:
              - column:
                  name: main_flight_id
        - createIndex:
            indexName: idx_flights_parent_flight
            tableName: flights
            columns:
              - column:
                  name: parent_flight_id
        - createIndex:
            indexName: idx_flights_connecting
            tableName: flights
            columns:
              - column:
                  name: is_connecting_flight

  - changeSet:
      id: add-flight-connections-unique-constraints
      author: flight-management-team
      changes:
        - addUniqueConstraint:
            tableName: flight_connections
            columnNames: main_flight_id, segment_flight_id, segment_order
            constraintName: unique_flight_connection_segment