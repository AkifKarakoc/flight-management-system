databaseChangeLog:
  - changeSet:
      id: 003-create-flight-connections-table
      author: flight-management-team
      comment: "Create flight_connections table for connecting flights"
      changes:
        - createTable:
            tableName: flight_connections
            columns:
              - column:
                  name: id
                  type: BIGINT
                  autoIncrement: true
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: main_flight_id
                  type: BIGINT
                  constraints:
                    nullable: false
              - column:
                  name: segment_flight_id
                  type: BIGINT
                  constraints:
                    nullable: false
              - column:
                  name: segment_order
                  type: INTEGER
                  constraints:
                    nullable: false
              - column:
                  name: connection_time_minutes
                  type: INTEGER
                  constraints:
                    nullable: true
              - column:
                  name: created_at
                  type: TIMESTAMP
                  defaultValueComputed: CURRENT_TIMESTAMP
                  constraints:
                    nullable: false
      rollback:
        - dropTable:
            tableName: flight_connections

  - changeSet:
      id: 003-add-flight-connections-foreign-keys
      author: flight-management-team
      comment: "Add foreign key constraints for flight_connections table"
      changes:
        - addForeignKeyConstraint:
            baseTableName: flight_connections
            baseColumnNames: main_flight_id
            constraintName: fk_flight_connections_main_flight
            referencedTableName: flights
            referencedColumnNames: id
            onDelete: CASCADE
            onUpdate: CASCADE
        - addForeignKeyConstraint:
            baseTableName: flight_connections
            baseColumnNames: segment_flight_id
            constraintName: fk_flight_connections_segment_flight
            referencedTableName: flights
            referencedColumnNames: id
            onDelete: CASCADE
            onUpdate: CASCADE
      rollback:
        - dropForeignKeyConstraint:
            baseTableName: flight_connections
            constraintName: fk_flight_connections_main_flight
        - dropForeignKeyConstraint:
            baseTableName: flight_connections
            constraintName: fk_flight_connections_segment_flight

  - changeSet:
      id: 003-add-flight-connections-indexes
      author: flight-management-team
      comment: "Add indexes for flight_connections table performance"
      changes:
        - createIndex:
            tableName: flight_connections
            indexName: idx_flight_connections_main_flight
            columns:
              - column:
                  name: main_flight_id
        - createIndex:
            tableName: flight_connections
            indexName: idx_flight_connections_segment_flight
            columns:
              - column:
                  name: segment_flight_id
        - createIndex:
            tableName: flight_connections
            indexName: idx_flight_connections_main_order
            columns:
              - column:
                  name: main_flight_id
              - column:
                  name: segment_order
        - createIndex:
            tableName: flight_connections
            indexName: idx_flight_connections_segment_order
            columns:
              - column:
                  name: segment_order
      rollback:
        - dropIndex:
            indexName: idx_flight_connections_main_flight
            tableName: flight_connections
        - dropIndex:
            indexName: idx_flight_connections_segment_flight
            tableName: flight_connections
        - dropIndex:
            indexName: idx_flight_connections_main_order
            tableName: flight_connections
        - dropIndex:
            indexName: idx_flight_connections_segment_order
            tableName: flight_connections

  - changeSet:
      id: 003-add-flight-connections-unique-constraints
      author: flight-management-team
      comment: "Add unique constraints for flight_connections table"
      changes:
        - addUniqueConstraint:
            tableName: flight_connections
            columnNames: main_flight_id, segment_order
            constraintName: uk_flight_connections_main_segment_order
        - addUniqueConstraint:
            tableName: flight_connections
            columnNames: segment_flight_id
            constraintName: uk_flight_connections_segment_flight
      rollback:
        - dropUniqueConstraint:
            tableName: flight_connections
            constraintName: uk_flight_connections_main_segment_order
        - dropUniqueConstraint:
            tableName: flight_connections
            constraintName: uk_flight_connections_segment_flight

  - changeSet:
      id: 003-add-flight-connections-check-constraints
      author: flight-management-team
      comment: "Add check constraints for data validation"
      changes:
        - sql:
            sql: >
              ALTER TABLE flight_connections 
              ADD CONSTRAINT chk_flight_connections_segment_order_positive 
              CHECK (segment_order > 0);
        - sql:
            sql: >
              ALTER TABLE flight_connections 
              ADD CONSTRAINT chk_flight_connections_connection_time_valid 
              CHECK (connection_time_minutes IS NULL OR (connection_time_minutes >= 0 AND connection_time_minutes <= 1440));
